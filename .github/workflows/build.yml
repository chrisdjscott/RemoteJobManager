name: Build

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9']
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Display Python version
        run: python --version

      - name: Build the package
        run: python -m pip install .[test]

      - name: Check rjm_batch_submit command installed
        run: rjm_batch_submit --help
      - name: Check rjm_batch_wait command installed
        run: rjm_batch_wait --help

      - name: Run tests
        run: pytest

      - run: mkdir -p ~/.rjm
      - run: printf "${RJM_CONFIG}" > ~/.rjm/rjm_config.ini
        shell: bash
        env:
          RJM_CONFIG: ${{ secrets.RJM_CONFIG }}
      - run: printf "${RJM_TOKENS}" > ~/.rjm/rjm_tokens.json
        shell: bash
        env:
          RJM_TOKENS: ${{ secrets.RJM_TOKENS }}
      - name: Run batch_submit for nonmem example
        run: rjm_batch_submit -f localdirs.txt -ll debug
        working-directory: ./examples/nonmem
      - name: Run batch_wait for nonmem example
        run: rjm_batch_wait -f localdirs.txt -ll debug
        working-directory: ./examples/nonmem
      - run: rm ~/.rjm/*

      # Build executables just on Windows
      - name: Install pyinstaller
        run: python -m pip install pyinstaller pip-licenses
        if: ${{ runner.os == 'Windows' && matrix.python-version == '3.9' }}
      - name: Build rjm_batch_submit
        run: pyinstaller -F ../../rjm/cli/rjm_batch_submit.py
        working-directory:  ./extra/pyinstaller
        if: ${{ runner.os == 'Windows' && matrix.python-version == '3.9' }}
      - name: Build rjm_batch_wait
        run: pyinstaller -F ../../rjm/cli/rjm_batch_wait.py
        working-directory:  ./extra/pyinstaller
        if: ${{ runner.os == 'Windows' && matrix.python-version == '3.9' }}
      - name: Build rjm_authenticate
        run: pyinstaller -F ../../rjm/cli/rjm_authenticate.py
        working-directory:  ./extra/pyinstaller
        if: ${{ runner.os == 'Windows' && matrix.python-version == '3.9' }}
      - name: Build rjm_configure
        run: pyinstaller -F ../../rjm/cli/rjm_configure.py
        working-directory:  ./extra/pyinstaller
        if: ${{ runner.os == 'Windows' && matrix.python-version == '3.9' }}
      - name: Build rjm_health_check
        run: pyinstaller -F ../../rjm/cli/rjm_health_check.py
        working-directory:  ./extra/pyinstaller
        if: ${{ runner.os == 'Windows' && matrix.python-version == '3.9' }}
      - name: Dump license files
        run: |
          pip-licenses -f plain-vertical -l --output-file dist/bundled_licenses.txt
          echo "Python license: https://docs.python.org/3/license.html" >> dist/bundled_licenses.txt
        working-directory: ./extra/pyinstaller
        if: ${{ runner.os == 'Windows' && matrix.python-version == '3.9' }}
      - name: Archive binaries
        uses: thedoctor0/zip-release@master
        with:
          type: zip
          directory: extra/pyinstaller/dist
          filename: RemoteJobManager-${{ runner.os }}.zip
        if: ${{ runner.os == 'Windows' && matrix.python-version == '3.9' }}
      - uses: actions/upload-artifact@v2
        with:
          name: RemoteJobManager-${{ runner.os }}
          path: extra/pyinstaller/dist/RemoteJobManager-*.zip
        if: ${{ runner.os == 'Windows' && matrix.python-version == '3.9' }}
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: extra/pyinstaller/dist/RemoteJobManager-*.zip
